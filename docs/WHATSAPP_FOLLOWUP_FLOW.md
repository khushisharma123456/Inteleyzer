# WhatsApp Follow-up Flow Documentation

## Overview

When a patient is added to the database, the PV Agent automatically triggers a WhatsApp follow-up conversation that spans Day 1, 3, 5, and 7. Each day has its own set of predefined questions plus personalized questions generated by Google Gemini based on the patient's case scoring data.

## Flow Diagram

```
Database Trigger (New Patient)
         │
         ▼
┌─────────────────────────┐
│   Case Scoring Engine   │
│  - Evaluates case       │
│  - Calculates scores    │
│  - Determines strength  │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│   Gemini API Call       │
│  - Receives case score  │
│  - Gets missing columns │
│  - Generates personalized│
│    questions for Day N  │
└──────────┬──────────────┘
           │
           ▼
┌─────────────────────────┐
│   WhatsApp Chatbot      │
│  - Sends welcome message│
│  - Language selection   │
│  - Asks questions 1-by-1│
└──────────┬──────────────┘
           │
           ▼
    [Day 3, 5, 7 repeat with new questions]
```

## Day-Specific Questions

### Day 1: Initial Assessment
**Predefined Questions:**
1. How are you feeling today after taking the medication?
2. Are you still experiencing the symptoms you reported earlier?
3. On a scale of 1-10, how would you rate the severity?
4. When did you first notice these symptoms?

**Gemini Focus:** Fill gaps in completeness, establish symptom timeline

---

### Day 3: Symptom Progression
**Predefined Questions:**
1. How have your symptoms changed since we last spoke? (Better/Same/Worse)
2. Have you consulted a doctor or healthcare provider?
3. Are you still taking the medication?
4. Have you noticed any new symptoms?

**Gemini Focus:** Track progression, check medical confirmation

---

### Day 5: Clinical Impact
**Predefined Questions:**
1. Are your symptoms improving, staying the same, or getting worse?
2. Did you need to visit a hospital or emergency room?
3. How have these symptoms affected your daily activities?
4. Have you taken any other medications to manage symptoms?

**Gemini Focus:** Assess severity, hospital visits, daily life impact

---

### Day 7: Resolution & Closure
**Predefined Questions:**
1. What is the current status of your symptoms?
2. If resolved, when did they stop?
3. Would you like us to arrange a free health check-up from the pharma company?
4. Is there anything else you would like to share?

**Gemini Focus:** Final status, resolution date, feedback collection

---

## How Gemini Personalization Works

1. **Case Scoring Data Sent to Gemini:**
   - Case Score (numerical)
   - Strength Level (Low/Medium/High)
   - Completeness percentage
   - Temporal Clarity Score
   - Medical Confirmation Score
   - Risk Level
   - Missing data columns

2. **Gemini Returns:**
   - 2-3 personalized questions based on gaps
   - Each question maps to a database column
   - Analysis of why these questions were chosen

3. **Example Gemini Prompt Context:**
   ```
   Current Day: Day 3
   Drug: Aspirin
   Case Score: 45
   Strength Level: Medium
   Missing Data: symptom_onset_date, doctor_confirmed
   
   Gemini generates questions to fill these gaps
   ```

## Code Flow

### 1. Patient Added → start_tracking()
```python
# pv_backend/services/followup_agent.py
orchestrator.start_tracking(patient)
# → Runs case scoring
# → Calls get_combined_questions(patient, current_day=1)
# → Creates AgentFollowupTracking record
# → Sends WhatsApp welcome message
```

### 2. Day 3/5/7 → process_day_cycle()
```python
orchestrator.process_day_cycle(tracking_id)
# → Re-runs case scoring with new data
# → Calls get_combined_questions(patient, previous_responses, current_day=N)
# → Updates tracking with new questions
# → Sends WhatsApp for new day
```

### 3. Question Generation
```python
# pv_backend/services/llm_service.py
get_combined_questions(patient, previous_responses, current_day)
# Returns:
# - predefined_questions: Day-specific static questions
# - llm_questions: Gemini-generated personalized questions
# - all_questions: Combined list for chatbot
```

## Key Files

| File | Purpose |
|------|---------|
| `llm_service.py` | Gemini API integration, question generation |
| `whatsapp_chatbot.py` | Handles WhatsApp conversation flow |
| `followup_agent.py` | Orchestrates the Day 1/3/5/7 cycle |
| `case_scoring.py` | Calculates case scores for Gemini |
| `privacy_utils.py` | Filters PII before sending to Gemini |

## Environment Variables Required

```bash
# Twilio WhatsApp
TWILIO_ACCOUNT_SID=your-account-sid
TWILIO_AUTH_TOKEN=your-auth-token
TWILIO_WHATSAPP_FROM=whatsapp:+14155238886

# Google Gemini
GOOGLE_API_KEY=your-gemini-api-key
```

## Testing the Flow

1. Add a new patient with a phone number
2. The system will automatically:
   - Run case scoring
   - Call Gemini for personalized questions
   - Send WhatsApp welcome message
3. Reply to WhatsApp to proceed through questions
4. After 2 days, Day 3 questions will be triggered
5. Continue through Day 5 and Day 7

## Notes

- Email is currently disabled (focus on WhatsApp)
- Patient can say "I'm fine" to stop follow-ups
- 2-hour reminders for unanswered questions
- Maximum 3 reminders per question
- 13 Indian regional languages supported
