# Patient Data Query Feature - Implementation Plan

Enable patients to request and view their own data through the WhatsApp conversational agent by querying the database when they ask for it.

## Overview

When a patient sends messages like "show my data", "my records", or "my visits", the conversational agent:
1. Detects the data query intent
2. Queries the database for patient information (identified by phone number)
3. Formats and returns the data as a WhatsApp message

## Files Created/Modified

### New Files

| File | Purpose |
|------|---------|
| `db_utils.py` | Database connection, queries, intent detection, message formatting |
| `.env.example` | Template for database configuration variables |
| `test_data_query.py` | Test script for intent detection |

### Modified Files

| File | Changes |
|------|---------|
| `ConversationalAgent.py` | Added data query detection in `process_input()` |
| `agentBackend.py` | Added logging for data query responses |

---

## Database Schema Reference

The feature uses these tables from `schema.sql`:

- **Patient** - Patient demographics (name, phone, age, gender)
- **Visit** - Visit records linking patients and doctors
- **Doctor** - Doctor information
- **Doctor_Entry** - Prescriptions and medication details
- **Patient_Response** - Responses collected during conversations
- **Data_Quality_Report** - Quality reports generated by Agent 2

---

## Recognized Keywords

The agent recognizes these patterns as data queries:

### Full Data Requests
- `show my data` / `show my records` / `show my information`
- `view my data` / `view my records` / `view my information`
- `get my data` / `get my records` / `see my data`
- `my data` / `my records` / `my information`

### Specific Requests
- `my visits` / `my appointments` / `my visit history`
- `my prescriptions` / `my medicines` / `my medication`
- `my treatment` / `my responses` / `my answers`

### Hindi Keywords
- `mera data` / `meri information`

### Specific Visit
- `visit id 1` / `show visit 123`

---

## Sample Output Format

When patient asks "show my data":

```
ğŸ“‹ *Your Medical Records*

ğŸ‘¤ *Patient Information*
Name: John Doe
Patient ID: P001
Age: 45
Gender: Male

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“… *Visit 1*
Visit ID: 1
Date: 2026-01-08
Type: New
Disease: Hypertension
Doctor: Dr. Sharma
Department: Cardiology
Status: Completed

ğŸ’Š *Prescribed Medicine*
Medicine: Amlodipine
Dosage: 5mg
Frequency: Once daily
Duration: 30 days

ğŸ“ *Your Responses*
â€¢ Language: English
â€¢ Medicine Started: Yes
â€¢ Adherence: Daily
â€¢ Food Relation: After food
â€¢ New Symptoms: No

ğŸ“Š *Data Quality*: âœ… PASS (Score: 1.0)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ’¬ Reply with a number to continue your follow-up,
or type 'help' for assistance.
```

---

## Configuration

### Environment Variables

Copy `.env.example` to `.env` and configure:

```env
# Database type: 'mysql', 'postgresql', or 'sqlite'
DB_TYPE=mysql

# For MySQL/PostgreSQL
DB_HOST=localhost
DB_PORT=3306
DB_NAME=pharmacovigilance
DB_USER=your_db_user
DB_PASSWORD=your_db_password

# For SQLite (development/testing)
# DB_TYPE=sqlite
# SQLITE_DB_PATH=dataset/pharmacovigilance.db
```

### Required Dependencies

```bash
# For MySQL
pip install mysql-connector-python

# For PostgreSQL
pip install psycopg2-binary

# SQLite is built into Python
```

---

## Flow Diagram

```
Patient sends message
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Is it a data query?   â”‚
â”‚ (detect_data_query_   â”‚
â”‚  intent)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   Yes â”€â”´â”€ No
        â”‚    â””â”€â”€â”€â”€â”€â”€â–º Continue normal flow
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Get patient by phone  â”‚
â”‚ number                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Query database for    â”‚
â”‚ visits, prescriptions,â”‚
â”‚ responses             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Format data for       â”‚
â”‚ WhatsApp              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
    Send to patient
```

---

## Privacy & Security

- **Patient-only access**: Patients can ONLY see their own data (matched by phone number)
- **SQL injection prevention**: All queries use parameterized statements
- **No cross-patient leakage**: Phone number verification before returning any data

---

## Testing

Run the test script:
```bash
python test_data_query.py
```

Expected output shows each test message and whether it's detected as a data query.

---

## Future Enhancements

1. Add support for more languages (Tamil, Telugu, Malayalam)
2. Allow patients to filter by date range
3. Add pagination for patients with many visits
4. Export data to PDF for patient records
